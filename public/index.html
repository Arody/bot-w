<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Manager</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <div class="container">
        <!-- Bot√≥n hamburguesa -->
        <button id="hamburger-btn" class="hamburger-btn" aria-label="Abrir men√∫">
            <span></span>
            <span></span>
            <span></span>
        </button>
        
        <!-- Overlay para cerrar sidebar -->
        <div id="sidebar-overlay" class="sidebar-overlay hidden"></div>
        
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>Sesiones</h2>
                <button id="close-sidebar-btn" class="btn-icon close-sidebar-btn" aria-label="Cerrar men√∫">√ó</button>
            </div>
            <div class="sidebar-content">
                <div class="input-group">
                    <input type="text" id="new-session-input" placeholder="Nueva sesi√≥n">
                    <button id="add-session-btn" class="btn-primary">+</button>
                </div>
                <div class="sidebar-actions">
                    <button id="open-settings-btn" class="btn-secondary">Claves API</button>
                </div>
                <ul id="session-list">
                    <!-- Sessions will be injected here -->
                </ul>
            </div>
        </div>
        <div class="main-content">
            <div id="welcome-screen">
                <h1>Selecciona una sesi√≥n o crea una nueva</h1>
            </div>
            <div id="session-details" class="hidden">
                <div class="session-header">
                    <div class="session-header-info">
                        <h2 id="session-title">Session ID</h2>
                        <div id="status-container">
                            <span class="status-dot" id="status-dot"></span>
                            <span id="connection-status">Desconectado</span>
                        </div>
                    </div>
                    <div class="session-header-actions">
                        <button id="manage-buttons-btn" class="btn-icon-text" title="Configurar botones interactivos">
                            <span class="icon">üîò</span>
                            <span>Botones</span>
                        </button>
                        <button id="toggle-config-btn" class="btn-icon-text" title="Configuraci√≥n del bot">
                            <span class="icon">‚öôÔ∏è</span>
                            <span>Configuraci√≥n</span>
                        </button>
                        <button id="delete-session-btn" class="btn-danger-small">Eliminar</button>
                    </div>
                </div>
                
                <div id="qr-container" class="hidden">
                    <img id="qr-image" src="" alt="QR Code">
                    <p id="qr-text">Escanea este c√≥digo QR con WhatsApp</p>
                </div>
                
                <!-- Panel de configuraci√≥n plegable -->
                <div id="config-panel" class="config-panel collapsed">
                    <div class="config-panel-content">
                        <div class="config-section">
                            <div class="config-row">
                                <div class="bot-toggle-row">
                                    <label class="switch">
                                        <input type="checkbox" id="bot-toggle">
                                        <span class="slider round"></span>
                                    </label>
                                    <span id="bot-status-text">Bot deshabilitado</span>
                                    <span id="bot-provider-pill" class="provider-pill">Gemini</span>
                                </div>
                            </div>
                            <div class="config-grid">
                                <div class="config-field">
                                    <label for="model-provider-select">Proveedor</label>
                                    <select id="model-provider-select">
                                        <option value="gemini">Gemini</option>
                                        <option value="openai">OpenAI</option>
                                    </select>
                                </div>
                                <div class="config-field">
                                    <label for="model-name-input">Modelo</label>
                                    <input type="text" id="model-name-input" placeholder="gemini-2.0-flash">
                                </div>
                            </div>
                            <div class="config-field">
                                <label for="system-prompt-input">Mensaje del sistema</label>
                                <textarea id="system-prompt-input" rows="3" placeholder="Indica c√≥mo debe responder el bot"></textarea>
                            </div>
                            <div class="config-actions">
                                <button id="save-settings-btn" class="btn-primary">Guardar configuraci√≥n</button>
                                <span id="save-feedback" class="save-feedback hidden">Cambios guardados</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Vista de usuario conectado -->
                <div id="user-info" class="hidden">
                    <div class="user-info-header">
                        <p class="connected-as">Conectado como: <span id="user-name"></span></p>
                        <div class="section-actions">
                            <input type="text" id="conversation-search" placeholder="Buscar..." class="search-input">
                            <button id="refresh-conversations-btn" class="btn-icon" aria-label="Actualizar">&#8635;</button>
                        </div>
                    </div>
                    
                    <!-- Tablero Kanban - Embudo de Ventas -->
                    <div class="kanban-board" id="kanban-board">
                        <div class="kanban-column" data-stage="interest">
                            <div class="kanban-column-header">
                                <h4 class="kanban-title" data-stage="interest">Inter√©s</h4>
                                <span class="kanban-count" id="count-interest">0</span>
                            </div>
                            <div class="kanban-cards" id="cards-interest" data-stage="interest">
                                <!-- Cards de inter√©s -->
                            </div>
                        </div>
                        <div class="kanban-column" data-stage="quote">
                            <div class="kanban-column-header">
                                <h4 class="kanban-title" data-stage="quote">Cotizaci√≥n</h4>
                                <span class="kanban-count" id="count-quote">0</span>
                            </div>
                            <div class="kanban-cards" id="cards-quote" data-stage="quote">
                                <!-- Cards de cotizaci√≥n -->
                            </div>
                        </div>
                        <div class="kanban-column" data-stage="negotiation">
                            <div class="kanban-column-header">
                                <h4 class="kanban-title" data-stage="negotiation">Negociaci√≥n</h4>
                                <span class="kanban-count" id="count-negotiation">0</span>
                            </div>
                            <div class="kanban-cards" id="cards-negotiation" data-stage="negotiation">
                                <!-- Cards de negociaci√≥n -->
                            </div>
                        </div>
                        <div class="kanban-column" data-stage="closed">
                            <div class="kanban-column-header">
                                <h4 class="kanban-title" data-stage="closed">Cerrado</h4>
                                <span class="kanban-count" id="count-closed">0</span>
                            </div>
                            <div class="kanban-cards" id="cards-closed" data-stage="closed">
                                <!-- Cards cerrados -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Vista de chat activo -->
                    <div id="active-chat" class="active-chat hidden">
                        <div class="chat-header">
                            <button id="close-chat-btn" class="btn-icon" aria-label="Cerrar chat">‚Üê</button>
                            <div class="chat-contact-info">
                                <span id="chat-contact-name">Contacto</span>
                                <span id="chat-contact-status" class="chat-status"></span>
                            </div>
                            <button id="export-chat-btn" class="btn-icon" aria-label="Exportar">‚¨á</button>
                        </div>
                        <div id="chat-messages" class="chat-messages">
                            <!-- Mensajes se inyectar√°n aqu√≠ -->
                        </div>
                        <div id="chat-input-container" class="chat-input-container hidden">
                            <div class="chat-input-row">
                                <div class="chat-attachments">
                                    <button id="attach-image-btn" class="btn-attach" title="Enviar imagen">üì∑</button>
                                    <button id="attach-doc-btn" class="btn-attach" title="Enviar documento">üìÑ</button>
                                    <button id="send-buttons-btn" class="btn-attach" title="Enviar botones">üîò</button>
                                </div>
                                <input type="text" id="chat-input" placeholder="Escribe un mensaje..." class="chat-input">
                                <button id="send-message-btn" class="btn-send">Enviar</button>
                            </div>
                            <input type="file" id="image-upload" accept="image/*" style="display: none;">
                            <input type="file" id="doc-upload" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.zip,.rar" style="display: none;">
                        </div>
                        <div id="bot-active-notice" class="bot-active-notice hidden">
                            <span>ü§ñ El bot est√° respondiendo autom√°ticamente</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de configuraci√≥n de claves -->
    <div id="settings-overlay" class="modal-overlay hidden"></div>
    <div id="settings-modal" class="settings-modal hidden">
        <div class="settings-modal-content">
            <div class="modal-header">
                <h3>Claves API</h3>
                <button id="close-settings-btn" class="btn-icon" aria-label="Cerrar">&times;</button>
            </div>
            <p class="helper-text">Las claves se guardan en tu navegador y puedes exportarlas como JSON.</p>
            <div class="api-entry">
                <div class="api-entry-header">
                    <h4>OpenAI</h4>
                </div>
                <input type="password" id="openai-key-input" placeholder="sk-...">
                <div class="button-row">
                    <button id="save-openai-key" class="btn-primary">Guardar</button>
                    <button id="delete-openai-key" class="btn-link">Eliminar</button>
                </div>
            </div>
            <div class="api-entry">
                <div class="api-entry-header">
                    <h4>Gemini</h4>
                </div>
                <input type="password" id="gemini-key-input" placeholder="AIza...">
                <div class="button-row">
                    <button id="save-gemini-key" class="btn-primary">Guardar</button>
                    <button id="delete-gemini-key" class="btn-link">Eliminar</button>
                </div>
            </div>
            <button id="export-keys-btn" class="btn-outline full-width">Descargar JSON</button>
        </div>
    </div>
    
    <div id="toast" class="toast hidden" role="status" aria-live="polite"></div>
    
    <!-- Modal para gestionar botones -->
    <div id="buttons-modal-overlay" class="modal-overlay hidden"></div>
    <div id="buttons-modal" class="buttons-modal hidden">
        <div class="buttons-modal-content">
            <div class="modal-header">
                <h3>Botones Interactivos</h3>
                <button id="close-buttons-modal-btn" class="btn-icon" aria-label="Cerrar">&times;</button>
            </div>
            <p class="helper-text">Configura mensajes con botones que estar√°n disponibles para todos los chats de esta sesi√≥n.</p>
            
            <!-- Lista de botones existentes -->
            <div class="buttons-list" id="buttons-list">
                <p class="empty-buttons">No hay botones configurados</p>
            </div>
            
            <!-- Formulario para crear nuevo bot√≥n -->
            <div class="new-button-form">
                <h4>Crear nuevo mensaje con botones</h4>
                <div class="form-field">
                    <label for="btn-name-input">Nombre (para identificar)</label>
                    <input type="text" id="btn-name-input" placeholder="Ej: Men√∫ principal">
                </div>
                <div class="form-field">
                    <label for="btn-title-input">T√≠tulo del mensaje</label>
                    <input type="text" id="btn-title-input" placeholder="Ej: Men√∫ Principal">
                </div>
                <div class="form-field">
                    <label for="btn-body-input">Cuerpo del mensaje</label>
                    <textarea id="btn-body-input" rows="2" placeholder="Ej: Hola, selecciona una opci√≥n üëá"></textarea>
                </div>
                <div class="form-field">
                    <label for="btn-footer-input">Pie de mensaje (opcional)</label>
                    <input type="text" id="btn-footer-input" placeholder="Ej: Powered by Bot">
                </div>
                
                <div class="buttons-editor">
                    <label>Botones (m√°ximo 3)</label>
                    <div id="buttons-inputs">
                        <div class="button-input-row">
                            <input type="text" class="btn-text-input" placeholder="Texto del bot√≥n">
                            <input type="text" class="btn-id-input" placeholder="ID √∫nico">
                            <button class="btn-remove-row btn-icon" title="Eliminar">√ó</button>
                        </div>
                    </div>
                    <button id="add-button-row-btn" class="btn-link">+ A√±adir bot√≥n</button>
                </div>
                
                <button id="save-new-button-btn" class="btn-primary full-width">Guardar mensaje con botones</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para seleccionar bot√≥n a enviar -->
    <div id="send-button-modal-overlay" class="modal-overlay hidden"></div>
    <div id="send-button-modal" class="send-button-modal hidden">
        <div class="send-button-modal-content">
            <div class="modal-header">
                <h3>Enviar botones</h3>
                <button id="close-send-button-modal-btn" class="btn-icon" aria-label="Cerrar">&times;</button>
            </div>
            <p class="helper-text">Selecciona un mensaje con botones para enviar al chat actual.</p>
            
            <div class="available-buttons-list" id="available-buttons-list">
                <p class="empty-buttons">No hay botones configurados. Config√∫ralos primero.</p>
            </div>
        </div>
    </div>
    
    <!-- Modal para preview de imagen -->
    <div id="image-preview-modal-overlay" class="modal-overlay hidden"></div>
    <div id="image-preview-modal" class="image-preview-modal hidden">
        <div class="image-preview-content">
            <div class="modal-header">
                <h3>Enviar imagen</h3>
                <button id="close-image-preview-btn" class="btn-icon" aria-label="Cerrar">&times;</button>
            </div>
            <div class="image-preview-container">
                <img id="preview-image" src="" alt="Preview">
            </div>
            <div class="form-field">
                <label for="image-caption-input">Descripci√≥n (opcional)</label>
                <input type="text" id="image-caption-input" placeholder="A√±adir descripci√≥n...">
            </div>
            <button id="confirm-send-image-btn" class="btn-primary full-width">Enviar imagen</button>
        </div>
    </div>
    
    <!-- Modal para preview de documento -->
    <div id="doc-preview-modal-overlay" class="modal-overlay hidden"></div>
    <div id="doc-preview-modal" class="doc-preview-modal hidden">
        <div class="doc-preview-content">
            <div class="modal-header">
                <h3>Enviar documento</h3>
                <button id="close-doc-preview-btn" class="btn-icon" aria-label="Cerrar">&times;</button>
            </div>
            <div class="doc-preview-info">
                <span class="doc-icon">üìÑ</span>
                <div class="doc-details">
                    <p id="doc-name" class="doc-name">documento.pdf</p>
                    <p id="doc-size" class="doc-size">0 KB</p>
                </div>
            </div>
            <div class="form-field">
                <label for="doc-caption-input">Descripci√≥n (opcional)</label>
                <input type="text" id="doc-caption-input" placeholder="A√±adir descripci√≥n...">
            </div>
            <button id="confirm-send-doc-btn" class="btn-primary full-width">Enviar documento</button>
        </div>
    </div>
    
    <!-- Modal para editar nombre y descripci√≥n del chat -->
    <div id="edit-chat-modal-overlay" class="modal-overlay hidden"></div>
    <div id="edit-chat-modal" class="edit-chat-modal hidden">
        <div class="edit-chat-content">
            <div class="modal-header">
                <h3>Editar informaci√≥n del chat</h3>
                <button id="close-edit-chat-btn" class="btn-icon" aria-label="Cerrar">&times;</button>
            </div>
            <div class="form-field">
                <label for="chat-custom-name-input">Nombre personalizado</label>
                <input type="text" id="chat-custom-name-input" placeholder="Ej: Cliente VIP, Proveedor X, etc.">
                <small class="field-hint">Si est√° vac√≠o, se mostrar√° el nombre de WhatsApp</small>
            </div>
            <div class="form-field">
                <label for="chat-description-input">Descripci√≥n/Notas</label>
                <textarea id="chat-description-input" rows="3" placeholder="A√±ade notas sobre este contacto..."></textarea>
            </div>
            <button id="save-chat-info-btn" class="btn-primary full-width">Guardar cambios</button>
        </div>
    </div>
    
    <script src="app.js"></script>
</body>
</html>
